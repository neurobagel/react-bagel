name: Run tests

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up node env
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: build
        run: npm install && npm run build

      - name: Upload e2e coverage artifact
        uses: actions/upload-artifact@v3
        with:
          name: e2e-coverage
          path: coverage/.

  component-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: build
        run: npm install && npm run build

      - name: Run component tests
        uses: cypress-io/github-action@v6
        with:
          component: true
      
      - name: Upload component coverage artifact
        uses: actions/upload-artifact@v3
        with:
          name: component-coverage
          path: coverage/.

  merge-coverage:
    # Run this job only if both e2e and component tests passed
    needs: [e2e-test, component-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download e2e coverage artifacts
        uses: actions/download-artifact@v3
        with:
          name: e2e-coverage

      - name: Download component coverage artifacts
        uses: actions/download-artifact@v3
        with:
          name: component-coverage

      - name: Install nyc
        run: npm install nyc

      - name: Merge coverage reports
        run: nyc merge e2e-coverage e2e.json && nyc merge component-coverage component.json && nyc merge . combined-coverage.json

      - name: Generate final coverage report
        run: nyc report --reporter=lcov --temp-dir . --report-dir ./coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}  # Not required for public repos
          file: ./coverage/lcov.info
          flags: tests
          name: codecov-combined  
          fail_ci_if_error: true

